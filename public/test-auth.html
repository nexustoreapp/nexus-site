<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Teste Auth Nexus</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body { background:#0f0f0f; color:#eaeaea; font-family: Arial, sans-serif; padding:16px; }
    h2 { margin-bottom: 12px; }
    input, button { width:100%; padding:12px; margin:8px 0; font-size:16px; }
    button { background:#4f46e5; color:#fff; border:none; border-radius:6px; }
    pre { background:#000; color:#7CFC00; padding:12px; border-radius:6px; min-height:120px; white-space:pre-wrap; }
  </style>
</head>
<body>

<h2>Teste Auth Nexus</h2>

<input id="email" placeholder="Email" />
<input id="password" placeholder="Senha" type="password" />
<input id="cpf" placeholder="CPF (pode colar com ponto e traÃ§o)" />

<button id="btn-register">Registrar</button>
<button id="btn-verify">Verificar OTP</button>
<button id="btn-login">Login</button>

<pre id="out">Pronto.</pre>

<script>
const API = "https://nexus-site-oufm.onrender.com/api/auth";
const out = document.getElementById("out");

function show(v){
  out.textContent = typeof v === "string" ? v : JSON.stringify(v, null, 2);
}

// ðŸ”¹ remove tudo que nÃ£o Ã© nÃºmero (ponto/traÃ§o somem)
function onlyNumbers(v) {
  return v.replace(/\D/g, "");
}

// ðŸ”¹ valida CPF (algoritmo oficial)
function isValidCPF(cpf) {
  cpf = onlyNumbers(cpf);
  if (cpf.length !== 11) return false;
  if (/^(\d)\1+$/.test(cpf)) return false;

  let sum = 0;
  for (let i = 0; i < 9; i++) sum += cpf[i] * (10 - i);
  let d1 = (sum * 10) % 11;
  if (d1 === 10) d1 = 0;
  if (d1 != cpf[9]) return false;

  sum = 0;
  for (let i = 0; i < 10; i++) sum += cpf[i] * (11 - i);
  let d2 = (sum * 10) % 11;
  if (d2 === 10) d2 = 0;
  return d2 == cpf[10];
}

// ðŸ”¹ limpa automaticamente quando cola
document.getElementById("cpf").addEventListener("input", (e) => {
  e.target.value = onlyNumbers(e.target.value);
});

async function post(url, body){
  const r = await fetch(url, {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify(body)
  });
  const t = await r.text();
  try { return JSON.parse(t); }
  catch { return { ok:false, error:"NOT_JSON", raw:t.slice(0,200) }; }
}

document.getElementById("btn-register").onclick = async () => {
  show("Registrando...");

  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  const cpfRaw = document.getElementById("cpf").value;
  const cpf = onlyNumbers(cpfRaw);

  if (!isValidCPF(cpf)) {
    show("CPF invÃ¡lido. Verifique e tente novamente.");
    return;
  }

  const data = await post(API + "/register", { email, password, cpf });
  show(data);
};

document.getElementById("btn-verify").onclick = async () => {
  const otp = prompt("Digite o OTP:");
  if (!otp) return;
  show("Verificando OTP...");
  const data = await post(API + "/verify-otp", {
    email: document.getElementById("email").value.trim(),
    otp: otp.trim()
  });
  show(data);
};

document.getElementById("btn-login").onclick = async () => {
  show("Logando...");
  const data = await post(API + "/login", {
    email: document.getElementById("email").value.trim(),
    password: document.getElementById("password").value
  });
  show(data);
};
</script>

</body>
</html>